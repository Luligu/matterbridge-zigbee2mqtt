// .devcontainer/devcontainer.json

// This file defines the development container configuration for a Matterbridge Plugin.

/* 
  ************************************************* WARNING *************************************************
Dev containers have networking limitations depending on the host OS and Docker setup.

• Docker Desktop on Windows or macOS:
  - Runs inside a VM
  - Host networking mode is NOT available
  - Matterbridge and plugins can run but:
    ❌ Pairing with Matter controllers will NOT work cause of missing mDNS support
    ✅ Remote and local network access (cloud services, internet APIs) works normally
    ✅ Matterbridge frontend works normally

• Native Linux or WSL 2 with Docker Engine CLI integration:
  - Host networking IS available
  - Full local network access is supported
  - Matterbridge and plugins work correctly, including pairing
  - Matterbridge frontend works normally
  ************************************************* WARNING *************************************************
*/
{
  // Name of the dev container
  "name": "Matterbridge Plugin Dev Container",
  // Use the pre-built image with Node+TypeScript
  "image": "mcr.microsoft.com/vscode/devcontainers/typescript-node:latest",
  // Inherit timezone from the host environment (set TZ on the host, e.g. Europe/Paris)
  "containerEnv": {
    "TZ": "${localEnv:TZ}"
  },
  // Mount the local matterbridge and node_modules workspace folder to the container's workspace volumes to improve performance
  "mounts": [
    "source=${localWorkspaceFolderBasename}-node_modules,target=${containerWorkspaceFolder}/node_modules,type=volume",
    "source=${localWorkspaceFolderBasename}-cache,target=${containerWorkspaceFolder}/.cache,type=volume",
    "source=${localWorkspaceFolderBasename}-plugins,target=/home/node/Matterbridge,type=volume",
    "source=${localWorkspaceFolderBasename}-storage,target=/home/node/.matterbridge,type=volume",
    "source=${localWorkspaceFolderBasename}-cert,target=/home/node/.mattercert,type=volume",
    "source=matterbridge,target=/matterbridge,type=volume"
  ],
  // Create the matterbridge Docker network if it doesn't exist (runs on the HOST before the container starts).
  "initializeCommand": "docker network inspect matterbridge || docker network create matterbridge",
  // On startup, update npm, install and link the dev of matterbridge and install and build the plugin
  "postCreateCommand": "bash .devcontainer/postCreateCommand.sh",
  "runArgs": [
    // Give the Docker container the same name as the repository (must be unique on host)
    "--name",
    "${localWorkspaceFolderBasename}",
    // Use network host mode if on Docker Engine on Linux or WSL 2 to allow full local network access and mDNS support
    // "--network=host"
    // Use a shared bridge network to allow to access other containers with their names (dns resolution). With the default bridge, dns resolution does not work (only ip:port).
    "--network=matterbridge"
  ],
  // Publish the Matterbridge UI port on the Docker host (so http://localhost:8283 works even without VS Code port forwarding)
  "appPort": [8283],
  "customizations": {
    "vscode": {
      // Extensions to install in the dev container
      "extensions": [
        "ms-vscode.vscode-typescript-next",
        "ms-azuretools.vscode-containers",
        "dbaeumer.vscode-eslint",
        "esbenp.prettier-vscode",
        "github.copilot-chat",
        "github.vscode-github-actions",
        "github.vscode-pull-request-github"
      ],
      // Settings for the VS Code environment
      "settings": {
        "terminal.integrated.shell.linux": "/bin/bash",
        "terminal.integrated.scrollback": 10000,
        "editor.tabSize": 2,
        "editor.formatOnSave": true,
        "editor.codeActionsOnSave": {
          "source.fixAll.eslint": "explicit"
        },
        "eslint.format.enable": true,
        "eslint.useFlatConfig": true,
        "diffEditor.ignoreTrimWhitespace": false,
        "git.autofetch": true,
        "files.eol": "\n",
        "files.insertFinalNewline": true,
        "files.trimFinalNewlines": true
      }
    }
  }
}
